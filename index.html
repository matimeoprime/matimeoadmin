<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MaTimeo Admin Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

<script src="https://cdn.jsdelivr.com/npm/chart.js"></script>

<style>
/* ------------------------------------------------------------------ */
/* Global Theme Changes: Dark Mode Base */
/* ------------------------------------------------------------------ */
body {
    background-color: #1f2937; /* Dark Gray/Near Black for main background */
    color: white; /* Default text color is white */
}
.bg-white { background-color: #2c2c2e !important; } /* Make all 'white' cards dark */
.text-gray-900, .text-gray-700 { color: white !important; } /* Ensure headers are white */
.text-gray-500, .text-gray-600 { color: #d1d5db !important; } /* Lighter gray for subtle text */
.border-gray-100 { border-color: #374151 !important; } /* Darker borders */

/* Top nav desktop */
.top-nav-desktop { background-color:#facc15; box-shadow:0 2px 4px rgba(0,0,0,0.4); }
.nav-item-desktop { color:#1f2937; padding:0.75rem 1rem; font-weight:600; }
.nav-item-desktop:hover{ background-color:#eab308; }
.nav-item-desktop.active{ border-bottom:3px solid #1f2937; }

/* Bottom nav mobile (Already dark) */
.bottom-nav{ background-color:#000000; color:white; } 
.bottom-nav-item.active{ color:#facc15; }
.bottom-nav-item{ display:flex; flex-direction:column; align-items:center; font-size:0.75rem; padding:0.5rem 0; }
.bottom-nav-item span{ margin-top:0.25rem; }

/* Dashboard buttons */
.dark-card-btn{ background-color:#2c2c2e; color:white; border-radius:0.75rem; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
.dark-card-btn:hover{ background-color:#3a3a3c; }
.dashboard-correspondence-btn{ background-color:#facc15; color:#1f2937; border-radius:0.75rem; font-weight:600; }
.dashboard-correspondence-btn:hover{ background-color:#eab308; }

/* Main content padding */
.main-content-area{ padding-top:1rem; overflow-y:auto; flex:1; -ms-overflow-style:none; scrollbar-width:none; }
.main-content-area::-webkit-scrollbar{ display:none; }
@media(min-width:768px){ .main-content-area{ padding-top:6rem; } }

/* Responsive charts */
.chart-container{ position:relative; width:100%; height:300px; }
@media(min-width:768px){ .chart-container{ height:400px; } }

/* ------------------------------------------------------------------ */
/* Modal Styling: Black background with Yellow Content */
/* ------------------------------------------------------------------ */
#modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:50; }
#modal .modal-content{ 
    background-color: #facc15; /* Yellow background */
    color: white; /* White text inside the modal */
    width:90%; max-width:500px; padding:1rem; border-radius:0.75rem; 
}
#modal .modal-content h3 { color: #1f2937 !important; } /* Modal Title dark */
#modal form label { color: #1f2937 !important; } /* Modal labels dark */
/* Modal input fields need white background for contrast */
#modal form input, #modal form select, #modal form textarea{ 
    width:100%; margin-bottom:0.5rem; padding:0.5rem; 
    border:1px solid #1f2937; border-radius:0.25rem; 
    background-color: white; 
    color: #1f2937; /* Dark text in input fields */
}
#modal form select option { color: #1f2937; } /* Options text dark */
#modal .modal-content button { 
    background-color: #1f2937; /* Dark button background */
    color: white; 
    transition: background-color 0.15s;
}
#modal .modal-content #closeModal { 
    background-color: #d1d5db; /* Lighter background for Cancel button */
    color: #1f2937;
}

/* Custom List Card Styles - Adjusting for dark background */
.list-card, .detail-card-mobile, .top-product-item {
    background-color: #2c2c2e; /* Darker card background */
}
.list-card-amount-sale { color: #4ade80; } /* Lighter green for dark mode */
.list-card-amount-expense { color: #f87171; } /* Lighter red for dark mode */
.top-product-item { border-left-color: #facc15; }
.top-product-rank { background-color: #facc15; color: #1f2937; }

.detail-card-mobile .bg-green-500 { background-color: #4ade80 !important; }
.detail-card-mobile .bg-blue-500 { background-color: #60a5fa !important; }


</style>
</head>
<body class="bg-gray-900 flex flex-col h-screen">

<header class="hidden md:flex top-nav-desktop w-full fixed top-0 z-50 justify-between items-center px-6">
¬† <div class="p-4"><h1 class="text-2xl font-bold text-gray-900">MaTimeo Admin</h1></div>
¬† <nav class="flex space-x-2 h-full">
¬† ¬† <button id="showDashboard" class="nav-item-desktop active">Dashboard</button>
¬† ¬† <button id="showSales" class="nav-item-desktop">Sales</button>
¬† ¬† <button id="showInventory" class="nav-item-desktop">Inventory</button>
¬† ¬† <button id="showExpenses" class="nav-item-desktop">Expenses</button>
¬† ¬† <button id="showReports" class="nav-item-desktop">Reports</button>
¬† ¬† <button id="showContacts" class="nav-item-desktop">Contacts</button>
¬† </nav>
</header>

<main class="flex-1 flex flex-col overflow-y-auto p-4 main-content-area">
¬† ¬† <section id="dashboardSection">
¬† ¬† <h2 class="text-xl font-semibold mb-5">Dashboard Overview</h2>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <div class="lg:col-span-2">
            
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-md text-center">
                    <p class="text-gray-500 text-sm">Total Sales</p>
                    <h3 id="sales" class="text-2xl font-bold text-gray-900">‚Çµ0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md text-center">
                    <p class="text-gray-500 text-sm">Net Revenue</p>
                    <h3 id="revenue" class="text-2xl font-bold text-gray-900">‚Çµ0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md text-center">
                    <p class="text-gray-500 text-sm">Total Expenses</p>
                    <h3 id="expenses" class="text-2xl font-bold text-gray-900">‚Çµ0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md text-center sm:hidden">
                    <p class="text-gray-500 text-sm">Stock Alerts</p>
                    <h3 id="stockMobile" class="text-2xl font-bold text-red-600">0</h3>
                </div>
            </div>

            <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-6">
                <button id="goToSalesBtn" class="dark-card-btn px-4 py-3 flex flex-col items-center justify-center text-sm sm:text-base"><span class="text-2xl mb-1">üìà</span>Add Sale</button>
                <button id="addExpenseBtn" class="dark-card-btn px-4 py-3 flex flex-col items-center justify-center text-sm sm:text-base"><span class="text-2xl mb-1">‚¨áÔ∏è</span>Add Expense</button>
                <button id="goToInventoryBtn" class="dashboard-correspondence-btn px-4 py-3 flex flex-col items-center justify-center text-sm sm:text-base"><span class="text-2xl mb-1">üì¶</span>Inventory</button>
                <button id="goToReportsBtn" class="dashboard-correspondence-btn px-4 py-3 flex flex-col items-center justify-center text-sm sm:text-base"><span class="text-2xl mb-1">üìÑ</span>Reports</button>
                <button id="goToContactsBtn" class="dashboard-correspondence-btn px-4 py-3 flex flex-col items-center justify-center text-sm sm:text-base"><span class="text-2xl mb-1">üë§</span>Contacts</button>
            </div>

            <section class="chart-container bg-white p-4 rounded-xl shadow-md mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Sales Trend</h3>
                <canvas id="salesChart"></canvas>
            </section>
        </div>

        <div class="lg:col-span-1">
            
            <div class="bg-white p-4 rounded-xl shadow-md text-center mb-6 hidden sm:block">
                <p class="text-gray-500 text-sm">Stock Alerts</p>
                <h3 id="stock" class="text-2xl font-bold text-red-600">0</h3>
            </div>

            <section class="bg-white p-4 rounded-xl shadow-md mb-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Top 5 Selling Products (‚Çµ)</h3>
                <div id="topProductsList" class="space-y-2">
                    <p class="text-gray-500">Loading top products...</p>
                </div>
            </section>

            <section class="chart-container bg-white p-4 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Top Products Chart (Visual)</h3>
                <canvas id="topProductsChart"></canvas>
            </section>
        </div>
    </div>
¬† </section>

¬† ¬† <section id="salesSection" class="hidden">
¬† ¬† <h2 class="text-xl font-semibold mb-3">Sales & Transactions</h2>
    <button id="addSaleBtnSection" class="bg-yellow-400 px-4 py-2 rounded-lg shadow font-medium hover:bg-yellow-500 transition mb-4 flex items-center">
        <span class="text-lg mr-2">‚¨ÜÔ∏è</span> Record New Sale
    </button>
    <div id="salesList" class="space-y-3">
        <p class="text-gray-500">Loading recent sales...</p>
    </div>
¬† </section>

¬† ¬† <section id="inventorySection" class="hidden">
¬† ¬† <h2 class="text-xl font-semibold mb-3">Inventory</h2>
    <button id="addInventoryBtn" class="bg-yellow-400 px-4 py-2 rounded mb-4 hover:bg-yellow-500 transition">Add/Update Product</button>
    
    <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full bg-white shadow rounded-lg overflow-hidden">
            <thead class="bg-yellow-400 text-gray-900">
                <tr>
                    <th class="p-3 text-left">Product Name</th>
                    <th class="p-3 text-left">Retail Price (‚Çµ)</th>
                    <th class="p-3 text-left">Wholesale Price (‚Çµ)</th>
                    <th class="p-3 text-left">Stock Qty</th>
                    <th class="p-3 text-left">Threshold</th>
                    <th class="p-3 text-left">Actions</th>
                </tr>
            </thead>
            <tbody id="inventoryTableBody"></tbody>
        </table>
    </div>

    <div id="inventoryListMobile" class="md:hidden space-y-3">
        <p class="text-gray-500">Loading inventory...</p>
    </div>
¬† </section>

¬† ¬† <section id="expensesSection" class="hidden">
¬† ¬† <h2 class="text-xl font-semibold mb-3">Expenses Log</h2>
    <button id="addExpenseBtnSection" class="bg-yellow-400 px-4 py-2 rounded-lg shadow font-medium hover:bg-yellow-500 transition mb-4 flex items-center">
        <span class="text-lg mr-2">‚¨áÔ∏è</span> Record New Expense
    </button>
    <div id="expensesList" class="space-y-3">
        <p class="text-gray-500">Loading recent expenses...</p>
    </div>
¬† </section>

¬† ¬† <section id="reportsSection" class="hidden">
¬† ¬† <h2 class="text-xl font-semibold mb-3">Reports</h2>
    <div class="bg-white p-4 rounded-lg shadow-md">
        <p class="text-gray-700">Detailed financial reports and summaries will appear here once implemented.</p>
    </div>
¬† </section>

¬† ¬† <section id="contactsSection" class="hidden">
¬† ¬† <h2 class="text-xl font-semibold mb-3">Contacts (Customers & Suppliers)</h2>
    <button id="addContactBtnSection" class="bg-yellow-400 px-4 py-2 rounded mb-4 hover:bg-yellow-500 transition">Add Contact</button>
    
    <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full bg-white shadow rounded-lg overflow-hidden">
            <thead class="bg-yellow-400 text-gray-900">
                <tr>
                    <th class="p-3 text-left">Name</th>
                    <th class="p-3 text-left">Category</th>
                    <th class="p-3 text-left">Location</th>
                    <th class="p-3 text-left">Phone</th>
                    <th class="p-3 text-left">Actions</th>
                </tr>
            </thead>
            <tbody id="contactsTableBody"></tbody>
        </table>
    </div>
    
    <div id="contactsListMobile" class="md:hidden space-y-3">
        <p class="text-gray-500">Loading contacts...</p>
    </div>
¬† </section>
</main>

<nav class="fixed bottom-0 left-0 w-full md:hidden bottom-nav flex justify-around items-center h-16 shadow-lg z-40">
¬† <button id="navDashboard" class="bottom-nav-item active"><span>üè†</span><span>Dashboard</span></button>
¬† <button id="navSales" class="bottom-nav-item"><span>üìà</span><span>Sales</span></button>
¬† <button id="navInventory" class="bottom-nav-item"><span>üì¶</span><span>Inventory</span></button>
¬† <button id="navExpenses" class="bottom-nav-item"><span>üí∏</span><span>Expenses</span></button>
¬† <button id="navReports" class="bottom-nav-item"><span>üìÑ</span><span>Reports</span></button>
</nav>

<div id="modal"><div class="modal-content"><h3 id="modalTitle" class="text-lg font-semibold mb-4"></h3><form id="modalForm"></form>
<div class="flex justify-end gap-2 mt-4"><button id="closeModal" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button><button id="submitModal" class="px-4 py-2 rounded bg-yellow-400 hover:bg-yellow-500">Submit</button></div></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    runTransaction, 
    doc,
    deleteDoc, 
    query
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// !!! FIREBASE CONFIGURATION - Replace with your actual credentials !!!
const firebaseConfig = {
  apiKey: "AIzaSyAReXlAw2gKlaOicLx1Ag3wri5aERSTL7w",
  authDomain: "matimeo-d0d47.firebaseapp.com",
  projectId: "matimeo-d0d47",
  storageBucket: "matimeo-d0d47.firebasestorage.app",
  messagingSenderId: "68997819213",
  appId: "1:68997819213:web:9bc993d8ab2eda6f002504"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Global Variables ---
let productList = []; 
let salesChart = null; 
let topProductsChart = null; 

// --- Section Toggling Logic (Unchanged) ---
const sections = {
    dashboard: document.getElementById("dashboardSection"),
    sales: document.getElementById("salesSection"),
    inventory: document.getElementById("inventorySection"),
    expenses: document.getElementById("expensesSection"),
    reports: document.getElementById("reportsSection"),
    contacts: document.getElementById("contactsSection")
};

function hideAllSections() {
    Object.values(sections).forEach(section => section.style.display = 'none');
    
    // Clear active states
    document.querySelectorAll('.nav-item-desktop').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.bottom-nav-item').forEach(btn => btn.classList.remove('active'));
}

function showSection(name) {
    hideAllSections();
    const sectionElement = sections[name];
    if (sectionElement) {
[O        sectionElement.style.display = 'block'; 
    }
    
    // Set active styles for desktop
    const desktopBtn = document.getElementById(`show${name.charAt(0).toUpperCase() + name.slice(1)}`);
    if (desktopBtn) desktopBtn.classList.add('active');

    // Set active styles for mobile
    const mobileBtn = document.getElementById(`nav${name.charAt(0).toUpperCase() + name.slice(1)}`);
    if (mobileBtn) mobileBtn.classList.add('active');
    
    // Load data specific to the section
    if (name === 'inventory') loadInventory();
    if (name === 'contacts') loadContacts();
    if (name === 'dashboard') loadData(); 
    if (name === 'sales') loadSalesList(); 
    if (name === 'expenses') loadExpensesList(); 
}

// Initial active section
showSection('dashboard');

// --- Navigation Handlers (Unchanged) ---
document.querySelectorAll('button[id^="show"]').forEach(btn => {
    const sectionName = btn.id.replace('show', '').toLowerCase();
    btn.addEventListener("click", () => showSection(sectionName));
});

document.querySelectorAll('button[id^="nav"]').forEach(btn => {
    const sectionName = btn.id.replace('nav', '').toLowerCase();
    btn.addEventListener("click", () => showSection(sectionName));
});

// Dashboard Quick Action Handlers
document.getElementById("goToInventoryBtn").addEventListener("click", () => showSection('inventory'));
document.getElementById("goToReportsBtn").addEventListener("click", () => showSection('reports'));
document.getElementById("goToContactsBtn").addEventListener("click", () => showSection('contacts'));

// --- Modal Logic (Unchanged functionality) ---
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalForm = document.getElementById("modalForm");
const submitModal = document.getElementById("submitModal");
document.getElementById("closeModal").addEventListener("click", () => modal.style.display = 'none');

function openModal(title, fields, submitCallback){
  modalTitle.innerText = title;
  modalForm.innerHTML = "";
  
  fields.forEach(f=>{
    const label = document.createElement("label");
    label.htmlFor = f.id;
    label.className = "block text-sm font-medium text-gray-700 mt-2";
    label.innerText = f.placeholder;
    modalForm.appendChild(label);

    const input = document.createElement(f.tag || "input"); 
    input.id = f.id;
    input.required = f.required || false;
    input.className = "w-full border p-2 rounded block";
    
    if (f.tag !== "select") {
        input.type = f.type || "text";
        if (f.defaultValue !== undefined) input.value = f.defaultValue;
    }
    
    if(f.options){
      input.innerHTML = f.options.map(o => `<option value="${o.value}" ${f.defaultValue === o.value ? 'selected' : ''}>${o.text}</option>`).join('');
    }

    modalForm.appendChild(input);
  });
  modal.style.display = 'flex';

  submitModal.onclick = async ()=>{
    const values = {};
    let formValid = true;
    
    fields.forEach(f=> {
        const inputElement = document.getElementById(f.id);
        values[f.id] = inputElement.value;
        
        if (f.required && (!values[f.id] || values[f.id] === '')) {
            formValid = false;
        }
    });

    if (!formValid) {
        alert("Please fill out all required fields.");
        return; 
    }
    
    try {
        await submitCallback(values); 
        modal.style.display = 'none'; 
        loadData();
        alert(`${title} added successfully!`); 
    } catch (error) {
        console.error("Submission failed:", error);
        alert(`Error submitting data: ${error.message}`);
    }
  };
}

// --- CORE DELETE FUNCTION (Unchanged) ---
async function deleteDocument(collectionName, docId) {
    if (confirm(`Are you sure you want to delete this record from ${collectionName}? This cannot be undone.`)) {
        try {
            await deleteDoc(doc(db, collectionName, docId));
            alert("Record deleted successfully!");
            // Refresh the view based on the collection
            if (collectionName === 'sales') await loadSalesList();
            if (collectionName === 'expenses') await loadExpensesList();
            if (collectionName === 'products') await loadInventory();
            if (collectionName === 'contacts') await loadContacts();
            
            // Refresh dashboard metrics
            await loadData();
        } catch (e) {
            console.error("Error deleting document: ", e);
            alert("Error deleting record. Check the console for details.");
        }
    }
}
// ----------------------------

// --- Data Input Functions ---

// 1. Add Sale 
const addSaleHandler = () => {
  if (productList.length === 0) {
    alert("No products available. Please add a product first via Inventory.");
    return;
  }
  
  // Use Retail Price as default calculation value
  const productOptions = productList.map(p => ({
    value: p.id, 
    text: `${p.name} (Retail: ‚Çµ${p.retailPrice || p.price})`
  }));
  productOptions.unshift({ value: '', text: '--- Select Product ---' });

  // Add an option to select the price type (Retail/Wholesale)
  const priceTypeOptions = [
    { value: 'retail', text: 'Retail Price' },
    { value: 'wholesale', text: 'Wholesale Price' }
  ];

  openModal("Record New Sale", [
    {id:"productID", placeholder:"Select Product", tag:"select", options: productOptions, required: true },
    {id:"priceType", placeholder:"Price Type", tag:"select", options: priceTypeOptions, defaultValue: 'retail', required: true },
    {id:"quantity", placeholder:"Quantity Sold", type:"number", required: true, defaultValue: 1}, 
    {id:"amount", placeholder:"Total Amount (‚Çµ) (Optional - Calculated)", type:"number"}
  ], async (vals) => {
    try {
        const product = productList.find(p => p.id === vals.productID);
        const quantity = parseInt(vals.quantity || 1);
        const priceType = vals.priceType;
        
        if (!product || quantity <= 0) {
            throw new Error("Invalid product selection or quantity.");
        }
        
        // Determine the price based on selection
        let unitPrice;
        if (priceType === 'wholesale') {
            unitPrice = product.wholesalePrice || product.retailPrice; 
        } else { // Default to retail
            unitPrice = product.retailPrice || product.price; 
        }

        if (!unitPrice) {
             throw new Error("Product price information is missing. Check Inventory.");
        }

        const amount = parseFloat(vals.amount || (unitPrice * quantity));

        await runTransaction(db, async (transaction) => {
          const productRef = doc(db, "products", vals.productID);
          const productDoc = await transaction.get(productRef);
          if (!productDoc.exists()) throw new Error(`Product '${product.name}' does not exist!`);
          
          const newStock = productDoc.data().stock - quantity;
          if (newStock < 0) throw new Error(`Insufficient stock for ${product.name}! Stock remaining: ${productDoc.data().stock}`);
          
          transaction.update(productRef, { stock: newStock });
          
          transaction.set(doc(collection(db, "sales")), { 
             productID: vals.productID,
             product: product.name,
             amount: amount,
             quantity: quantity,
             priceType: priceType, 
             unitPrice: unitPrice,
             date: new Date()
          });
        });

        if (sections.sales.style.display === 'block') loadSalesList();
    } catch(e) { 
        console.error("Error adding sale or updating stock: ", e); 
        throw new Error(`Error processing sale. Details: ${e.message || e}`); 
    }
  });
};

document.getElementById("goToSalesBtn").addEventListener("click", addSaleHandler); 
document.getElementById("addSaleBtnSection").addEventListener("click", addSaleHandler);


// 2. Add Expense 
const addExpenseHandler = () => openModal("Record New Expense", [
    {
        id:"category", 
        placeholder:"Expense Category", 
        tag:"select",
        options: [
            { value: '', text: '--- Select Category ---' },
            { value: 'Rent', text: 'Rent' },
            { value: 'Utilities', text: 'Utilities' },
            { value: 'Salaries', text: 'Salaries' },
            { value: 'Other', text: 'Other' }
        ],
        required: true 
    },
    {id:"amount", placeholder:"Amount (‚Çµ)", type:"number", required: true} 
], async (vals)=>{
  const amount = parseFloat(vals.amount);
  if(vals.category && vals.category !== '' && amount > 0) {
    await addDoc(collection(db,"expenses"),{
        amount: amount, 
        category: vals.category,
        date:new Date()
    }); 
    if (sections.expenses.style.display === 'block') loadExpensesList();
  } else {
     throw new Error("Please ensure category is selected and amount is positive.");
  }
});

document.getElementById("addExpenseBtn").addEventListener("click", addExpenseHandler);
document.getElementById("addExpenseBtnSection").addEventListener("click", addExpenseHandler);

// 3. Add/Update Product (Inventory)
const addUpdateProductHandler = () => openModal("Add/Update Product", [
  {id:"productName", placeholder:"Product Name", required: true},
  {id:"retailPrice", placeholder:"Retail Price (‚Çµ)", type:"number", required: true},
  {id:"wholesalePrice", placeholder:"Wholesale Price (‚Çµ)", type:"number", required: true},
  {id:"stock", placeholder:"Current Stock Quantity", type:"number", required: true},
  {id:"alertThreshold", placeholder:"Low Stock Threshold", type:"number", required: true, defaultValue: 10}
], async (vals) => {
    if(vals.productName) {
        await addDoc(collection(db, "products"), {
            name: vals.productName,
            retailPrice: parseFloat(vals.retailPrice || 0),
            wholesalePrice: parseFloat(vals.wholesalePrice || 0),
            stock: parseInt(vals.stock || 0),
            alertThreshold: parseInt(vals.alertThreshold || 10),
            dateAdded: new Date()
        });
        loadInventory();
    }
});

document.getElementById("addInventoryBtn").addEventListener("click", addUpdateProductHandler);

// 4. Add Contact 
const addContactHandler = () => openModal("Add Contact", [
  {id:"name", placeholder:"Name", required: true}, 
  {
      id:"category", 
      placeholder:"Category (Customer/Supplier)", 
      tag:"select", 
      options: [
          {value: '', text: '--- Select Category ---'}, 
          {value: 'Customer', text: 'Customer'}, 
          {value: 'Supplier', text: 'Supplier'}, 
          {value: 'Other', text: 'Other'}
      ],
      required: true 
  },
  {id:"location", placeholder:"Location/Address"},
  {id:"phone", placeholder:"Phone", type:"tel"},
  {id:"email", placeholder:"Email", type:"email"}
], async (vals)=>{
    if(vals.name && vals.category && vals.category !== '') {
        await addDoc(collection(db,"contacts"),vals); 
        loadContacts();
    } else {
        throw new Error("Please ensure Name and Category are filled out.");
    }
});

document.getElementById("addContactBtnSection").addEventListener("click", addContactHandler);


// --- Data Display Functions (Unchanged logic, will use new styles) ---

async function renderSalesChart(data){
  const ctx = document.getElementById('salesChart').getContext('2d');
  if(salesChart) salesChart.destroy();
  salesChart = new Chart(ctx, {
    type: 'line',
    data: data,
    options: {
        responsive: true, 
        maintainAspectRatio: false, 
        plugins: {legend: {display: true, labels: { color: 'white' }}}, 
        scales: {
            y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: 'white' } },
            x: { grid: { color: '#374151' }, ticks: { color: 'white' } }
        }
    }
  });
}

async function renderTopProductsChart(data){
  const ctx = document.getElementById('topProductsChart').getContext('2d');
  if(topProductsChart) topProductsChart.destroy(); 
  topProductsChart = new Chart(ctx, {
    type: 'bar', 
    data: data,
    options: {
        responsive: true, 
        maintainAspectRatio: false, 
        plugins: {legend: {display: false}}, 
        scales: {
            y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: 'white' } },
            x: { grid: { color: '#374151' }, ticks: { color: 'white' } }
        }
    }
  });
}

function renderTopProductsList(topProducts) {
    const listContainer = document.getElementById("topProductsList");
    listContainer.innerHTML = "";

    if (topProducts.length === 0) {
        listContainer.innerHTML = `<p class="text-gray-500">No sales data yet to determine top products.</p>`;
        return;
    }

    topProducts.forEach((p, index) => {
        const card = document.createElement("div");
        card.className = "top-product-item flex items-center justify-between";
        card.innerHTML = `
            <div class="flex items-center">
                <span class="top-product-rank">${index + 1}</span>
                <span class="top-product-name">${p[0]}</span>
            </div>
            <span class="top-product-amount">
                ‚Çµ${p[1].toLocaleString(undefined, {minimumFractionDigits: 2})}
            </span>
        `;
        listContainer.appendChild(card);
    });
}


async function loadData(){
  try {
    const salesSnap = await getDocs(collection(db,"sales"));
    const expensesSnap = await getDocs(collection(db,"expenses"));
    const productsSnap = await getDocs(collection(db, "products"));

    // 1. Metrics Calculation
    let totalSales = 0, totalExpenses = 0, lowStockCount = 0;
    const productTotals = {};
    const dailySales = {};
    productList = []; 

    productsSnap.forEach(doc => {
      const product = doc.data();
      productList.push({ id: doc.id, ...product }); 
      if (product.stock <= product.alertThreshold) lowStockCount++;
    });
    
    // --- Sample Data Initialization/Fix (Updated to match new pricing fields) ---
    const defaultProducts = [
        { name: "Milk Chocolate", retail: 22, wholesale: 25 },
        { name: "Milk and Plantain Chips", retail: 22, wholesale: 25 },
        { name: "Dark Chocolate", retail: 22, wholesale: 25 },
        { name: "Dark Chocolate with Ginger", retail: 27, wholesale: 24 },
        { name: "Milk Chocogrande", retail: 0, wholesale: 0 }, // Coming Soon
        { name: "Dark Chocogrande", retail: 0, wholesale: 0 }  // Coming Soon
    ];
    
    // Auto-populate if the database is empty or missing key products
    if (productList.length === 0 || !productList.some(p => p.name === "Dark Chocolate with Ginger")) {
        console.warn("Product list is empty or missing key items. Adding sample products for demonstration.");
        defaultProducts.forEach((p, index) => {
            // Only add mock data if it doesn't already exist in the list
            if (!productList.some(existingP => existingP.name === p.name)) {
                 productList.push({ 
                    id: `mock-id-${index}`, 
                    name: p.name, 
                    retailPrice: p.retail,
                    wholesalePrice: p.wholesale,
                    stock: 50 + index * 10,
                    alertThreshold: 5 
                });
            }
        });
    }
    // ----------------------------------------


    salesSnap.forEach(doc => {
      const d = doc.data();
      totalSales += d.amount || 0;
      const product = d.product || "Unknown";
      productTotals[product] = (productTotals[product] || 0) + (d.amount || 0);
      
      const saleDate = d.date.toDate().toISOString().split('T')[0];
      dailySales[saleDate] = (dailySales[saleDate] || 0) + (d.amount || 0);
    });

    expensesSnap.forEach(doc => totalExpenses += doc.data().amount || 0);
    
    // 2. Update Dashboard Cards
    document.getElementById("sales").innerText = `‚Çµ${totalSales.toLocaleString()}`; 
    document.getElementById("revenue").innerText = `‚Çµ${(totalSales - totalExpenses).toLocaleString()}`;
    document.getElementById("expenses").innerText = `‚Çµ${totalExpenses.toLocaleString()}`;
    document.getElementById("stock").innerText = lowStockCount;
    document.getElementById("stockMobile").innerText = lowStockCount;


    // 3. Prepare Top Products List & Chart Data
    const top = Object.entries(productTotals).sort((a,b) => b[1] - a[1]).slice(0, 5);
    renderTopProductsList(top);


    // 4. Prepare Chart Data
    const sortedDates = Object.keys(dailySales).sort();
    const salesData = {
        labels: sortedDates.map(dateKey => new Date(dateKey).toLocaleDateString()),
        datasets: [{
          label: 'Sales (‚Çµ)',
          data: sortedDates.map(dateKey => dailySales[dateKey]),
          backgroundColor: 'rgba(250,204,21,0.5)',
          borderColor: 'rgba(250,204,21,1)',
          tension: 0.3
        }]
    };
    
    const topProductsData = {
        labels: top.map(p => p[0]),
        datasets: [{
            label: 'Total Sales (‚Çµ)',
            data: top.map(p => p[1]),
            backgroundColor: '#facc15'
        }]
    };

    // 5. Render Charts
    renderSalesChart(salesData);
    renderTopProductsChart(topProductsData);

  } catch (e) { 
    console.error("CRITICAL ERROR in loadData: ", e);
    document.getElementById("sales").innerText = "Error!";
  }
}

async function loadSalesList() {
    try {
        const salesSnap = await getDocs(collection(db, "sales"));
        const salesList = document.getElementById("salesList");
        salesList.innerHTML = "";
        
        if (salesSnap.empty) {
            salesList.innerHTML = `<p class="text-gray-500 p-4 bg-white rounded-lg shadow-md">No sales recorded yet.</p>`;
            return;
        }

        salesSnap.forEach(doc => {
            const sale = doc.data();
            const date = sale.date.toDate ? sale.date.toDate().toLocaleDateString() : 'N/A';
            const time = sale.date.toDate ? sale.date.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const docId = doc.id; 
            const priceType = sale.priceType ? ` (${sale.priceType.charAt(0).toUpperCase() + sale.priceType.slice(1)})` : ''; 

            const card = document.createElement("div");
            card.className = "list-card";
            card.innerHTML = `
                <div class="flex-1">
                    <p class="font-medium text-white">${sale.product}</p>
                    <p class="text-sm text-gray-500">${date} ${time} | Qty: ${sale.quantity}${priceType}</p>
                </div>
                <div class="flex items-center">
                    <span class="list-card-amount-sale mr-4">
                        +‚Çµ${(sale.amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </span>
                    <button class="delete-btn" data-id="${docId}" data-collection="sales">üóëÔ∏è</button>
                </div>
            `;
            salesList.appendChild(card);
        });
        
        document.querySelectorAll('.delete-btn[data-collection="sales"]').forEach(button => {
            button.addEventListener('click', (e) => {
                const docId = e.currentTarget.dataset.id;
                deleteDocument('sales', docId);
            });
        });

    } catch (e) {
        console.error("Error loading sales list: ", e);
        document.getElementById("salesList").innerHTML = `<p class="text-red-500 p-4 bg-white rounded-lg shadow-md">Error loading sales data.</p>`;
    }
}

async function loadExpensesList() {
    try {
        const expensesSnap = await getDocs(collection(db, "expenses"));
        const expensesList = document.getElementById("expensesList");
        expensesList.innerHTML = "";
        
        if (expensesSnap.empty) {
            expensesList.innerHTML = `<p class="text-gray-500 p-4 bg-white rounded-lg shadow-md">No expenses recorded yet.</p>`;
            return;
        }

        expensesSnap.forEach(doc => {
            const expense = doc.data();
            const date = expense.date.toDate ? expense.date.toDate().toLocaleDateString() : 'N/A';
            const time = expense.date.toDate ? expense.date.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const docId = doc.id; 


            const card = document.createElement("div");
            card.className = "list-card";
            card.innerHTML = `
                <div class="flex-1">
                    <p class="font-medium text-white">${expense.category}</p>
                    <p class="text-sm text-gray-500">${date} ${time}</p>
                </div>
                <div class="flex items-center">
                    <span class="list-card-amount-expense mr-4">
                        -‚Çµ${(expense.amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </span>
                    <button class="delete-btn" data-id="${docId}" data-collection="expenses">üóëÔ∏è</button>
                </div>
            `;
            expensesList.appendChild(card);
        });

        document.querySelectorAll('.delete-btn[data-collection="expenses"]').forEach(button => {
            button.addEventListener('click', (e) => {
                const docId = e.currentTarget.dataset.id;
                deleteDocument('expenses', docId);
            });
        });

    } catch (e) {
        console.error("Error loading expenses list: ", e);
        document.getElementById("expensesList").innerHTML = `<p class="text-red-500 p-4 bg-white rounded-lg shadow-md">Error loading expense data.</p>`;
    }
}

async function loadInventory(){
    try {
        const productsSnap = await getDocs(collection(db, "products"));
        const tableBody = document.getElementById("inventoryTableBody");
        const mobileList = document.getElementById("inventoryListMobile");
        tableBody.innerHTML = "";
        mobileList.innerHTML = ""; 

        if (productsSnap.empty) {
            const emptyMessage = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No products found. Add one above!</td></tr>`;
            tableBody.innerHTML = emptyMessage;
            mobileList.innerHTML = `<p class="text-gray-500 p-4 bg-white rounded-lg shadow-md">No products found. Add one above!</p>`;
            return;
        }
        
        productsSnap.forEach(doc => {
            const p = doc.data();
            const docId = doc.id;
            const stockClass = p.stock <= p.alertThreshold ? 'text-red-600 font-bold' : 'text-gray-700';
            const stockStatus = p.stock <= p.alertThreshold ? `<span class="text-red-600 font-bold">Low: ${p.stock}</span>` : `<span class="text-green-600">${p.stock}</span>`;

            const retailPrice = (p.retailPrice || p.price || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
            const wholesalePrice = (p.wholesalePrice || 0).toLocaleString(undefined, {minimumFractionDigits: 2});


            // Desktop Table Row
            const row = document.createElement("tr");
            row.className = "border-t border-gray-100 hover:bg-yellow-50/50";
            row.innerHTML = `
                <td class="p-3 font-medium">${p.name}</td>
                <td class="p-3">‚Çµ${retailPrice}</td>
                <td class="p-3">‚Çµ${wholesalePrice}</td>
                <td class="p-3 ${stockClass}">${p.stock}</td>
                <td class="p-3">${p.alertThreshold}</td>
                <td class="p-3">
                    <button class="delete-btn" data-id="${docId}" data-collection="products">üóëÔ∏è</button>
                </td>
            `;
            tableBody.appendChild(row);

            // Mobile Card View
            const mobileCard = document.createElement("div");
            mobileCard.className = "detail-card-mobile flex justify-between items-center";
            mobileCard.innerHTML = `
                <div class="flex-1">
                    <p class="text-lg font-bold">${p.name}</p>
                    <p class="text-gray-600">Retail: ‚Çµ${retailPrice} | Wholesale: ‚Çµ${wholesalePrice}</p>
                    <p class="text-sm">Stock: ${stockStatus} (Threshold: ${p.alertThreshold})</p>
                </div>
                <button class="delete-btn" data-id="${docId}" data-collection="products">üóëÔ∏è</button>
            `;
            mobileList.appendChild(mobileCard);
        });

        // Attach event listeners for inventory delete buttons
        document.querySelectorAll('.delete-btn[data-collection="products"]').forEach(button => {
            button.addEventListener('click', (e) => {
                const docId = e.currentTarget.dataset.id;
                deleteDocument('products', docId);
            });
        });

    } catch (e) {
        console.error("Error loading inventory: ", e);
    }
}

async function loadContacts(){
  try {
    const contactsSnap = await getDocs(collection(db,"contacts"));
    const tableBody=document.getElementById("contactsTableBody");
    const mobileList = document.getElementById("contactsListMobile");
    tableBody.innerHTML="";
    mobileList.innerHTML=""; 

    if (contactsSnap.empty) {
        const emptyMessage = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No contacts found. Add one above!</td></tr>`;
        tableBody.innerHTML = emptyMessage;
        mobileList.innerHTML = `<p class="text-gray-500 p-4 bg-white rounded-lg shadow-md">No contacts found. Add one above!</p>`;
        return;
    }
    
    contactsSnap.forEach(doc=>{
      const c=doc.data();
      const docId = doc.id;
      
      // Desktop Table Row
      const row = document.createElement("tr");
      row.className = "border-t border-gray-100 hover:bg-yellow-50/50";
      row.innerHTML = `
        <td class="p-3 font-medium">${c.name}</td>
        <td class="p-3">${c.category}</td>
        <td class="p-3 text-gray-600">${c.location||"-"}</td>
        <td class="p-3 text-gray-600">${c.phone||"-"}</td>
        <td class="p-3">
             <button class="delete-btn" data-id="${docId}" data-collection="contacts">üóëÔ∏è</button>
        </td>
      `;
      tableBody.appendChild(row);

      // Mobile Card View
      const mobileCard = document.createElement("div");
      mobileCard.className = "detail-card-mobile flex justify-between items-center";
      mobileCard.innerHTML = `
        <div class="flex-1">
            <div class="flex justify-between items-center mb-1">
                <p class="text-lg font-bold">${c.name}</p>
                <span class="text-sm font-semibold p-1 rounded-full text-white ${c.category === 'Customer' ? 'bg-green-500' : 'bg-blue-500'}">${c.category}</span>
            </div>
            <p class="text-sm text-gray-600">Phone: ${c.phone||"-"}</p>
            <p class="text-sm text-gray-600">Location: ${c.location||"-"}</p>
        </div>
        <button class="delete-btn" data-id="${docId}" data-collection="contacts">üóëÔ∏è</button>
      `;
      mobileList.appendChild(mobileCard);

    });

    // Attach event listeners for contacts delete buttons
    document.querySelectorAll('.delete-btn[data-collection="contacts"]').forEach(button => {
        button.addEventListener('click', (e) => {
            const docId = e.currentTarget.dataset.id;
            deleteDocument('contacts', docId);
        });
    });

  } catch (e) { console.error("Error loading contacts: ", e); }
}

// Initial Data Load (to populate dashboard on startup)
loadData();
</script>
</body>
</html>
